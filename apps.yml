parameters:
    - name: version
      type: string
      default: ''

steps:
  - task: CmdLine@2
    displayName: Substitute packages version for ${{ parameters.version }}
    inputs:
      script: |
        del /f Packages.props
        rename  Packages.${{ parameters.version }}.props Packages.props
      workingDirectory: SmartPlugins 
      failOnStderr: true

  - task: DotNetCoreCLI@2
    displayName: "Restore packages"
    inputs:
      command: 'restore'
      projects: '**/*.sln'
      noCache: true
      verbosityRestore: 'Normal'

  - task: MSBuild@1
    displayName: "Build applications ${{ parameters.version }}"
    inputs:
      solution: 'SmartPlugins\SmartPlugins.sln'
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'
      msbuildArguments: '/p:Version=$(Build.BuildNumber)'
      
  - task: ArchiveFiles@2
    displayName: 'Archive CorrectNameMainPart ${{ parameters.version }}'
    inputs:
      rootFolderOrFile: 'SmartPlugins\Test\bin\Release\net48'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\apps\${{ parameters.version }}\AxCoDesign.Applications.CorrectNameMainPart.zip'
      replaceExistingArchive: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish apps'
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)\apps
      ArtifactName: 'apps'
      publishLocation: 'Container'